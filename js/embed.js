function checkMobile(){return null==navigator.userAgent.match(/iPad/i)&&null!=navigator.userAgent.match(/iphone|android|phone|mobile|wap|netfront|java|opera mobi|opera mini|ucweb|windows ce|symbian|symbianos|series|webos|sony|blackberry|dopod|nokia|samsung|palmsource|xda|pieplus|meizu|midp|cldc|motorola|foma|docomo|up.browser|up.link|blazer|helio|hosin|huawei|novarra|coolpad|webos|techfaith|palmsource|alcatel|amoi|ktouch|nexian|ericsson|philips|sagem|wellcom|bunjalloo|maui|smartphone|iemobile|spice|bird|zte-|longcos|pantech|gionee|portalmmm|jig browser|hiptop|benq|haier|^lct|320x320|240x320|176x220/i)}function sskadmin(e){var t="";return 0x566430a867000400==e.user_id?t=checkMobile()?'<span class="ua"><span class="sskadmin">Captain</span></span><br><br>':'<span class="ua"><span class="sskadmin">Captain</span></span>':checkMobile()&&(t="<br><br>"),t}function ua(e){var t=new Array,s="";if(t=e.match(/FireFox\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_firefox"><i class="fa fa-firefox"></i> FireFox'}else if(t=e.match(/Maxthon([\d]*)\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_maxthon"><i class="fa fa-globe"></i> Maxthon'}else if(t=e.match(/BIDUBrowser([\d]*)\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_ucweb"><i class="fa fa-globe"></i> 百度浏览器'}else if(t=e.match(/UBrowser([\d]*)\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_ucweb"><i class="fa fa-globe"></i> UCBrowser'}else if(t=e.match(/UCBrowser([\d]*)\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_ucweb"><i class="fa fa-globe"></i> UCBrowser'}else if(t=e.match(/MetaSr/gi))s='<span class="ua_sogou"><i class="fa fa-globe"></i> 搜狗浏览器';else if(t=e.match(/2345Explorer/gi))s='<span class="ua_2345explorer"><i class="fa fa-globe"></i> 2345王牌浏览器';else if(t=e.match(/2345chrome/gi))s='<span class="ua_2345chrome"><i class="fa fa-globe"></i> 2345加速浏览器';else if(t=e.match(/LBBROWSER/gi))s='<span class="ua_lbbrowser"><i class="fa fa-globe"></i> 猎豹安全浏览器';else if(t=e.match(/MicroMessenger\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_qq"><i class="fa fa-weixin"></i> 微信'}else if(t=e.match(/QQBrowser\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_qq"><i class="fa fa-qq"></i> QQ浏览器'}else if(t=e.match(/QQ\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_qq"><i class="fa fa-qq"></i> QQ浏览器'}else if(t=e.match(/MiuiBrowser\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_mi"><i class="fa fa-globe"></i> Miui浏览器'}else if(t=e.match(/Chrome([\d]*)\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_chrome"><i class="fa fa-chrome"></i> Chrome'}else if(t=e.match(/safari\/([^\s]+)/gi)){t[0].split("/");s='<span class="ua_apple"><i class="fa fa-safari"></i> Safari'}else if(t=e.match(/Opera[\s|\/]([^\s]+)/gi)){t[0].split("/");s='<span class="ua_opera"><i class="fa fa-opera"></i> Opera'}else s=(t=e.match(/Trident\/7.0/gi))?'<span class="ua_ie"><i class="fa fa-internet-explorer"></i> IE 11':(t=e.match(/MSIE\s([^\s|;]+)/gi))?'<span class="ua_ie"><i class="fa fa-internet-explorer"></i> IE '+t[0]:'<span class="ua_other"><i class="fa fa-globe"></i> 其它浏览器';return Mobile=checkMobile()?"<br><br>":"",s+"</span>"+Mobile}function os(e){return(e.match(/win/gi)?e.match(/nt 5.1/gi)?'<span class="os_xp"><i class="fa fa-windows"></i> Windows XP':e.match(/nt 6.1/gi)?'<span class="os_7"><i class="fa fa-windows"></i> Windows 7':e.match(/nt 6.2/gi)?'<span class="os_8"><i class="fa fa-windows"></i> Windows 8':e.match(/nt 6.3/gi)?'<span class="os_8_1"><i class="fa fa-windows"></i> Windows 8.1':e.match(/nt 10.0/gi)?'<span class="os_8_1"><i class="fa fa-windows"></i> Windows 10':e.match(/nt 6.0/gi)?'<span class="os_vista"><i class="fa fa-windows"></i> Windows Vista':e.match(/nt 5/gi)?'<span class="os_2000"><i class="fa fa-windows"></i> Windows 2000':'<span class="os_windows"><i class="fa fa-windows"></i> Windows':e.match(/android/gi)?'<span class="os_android"><i class="fa fa-android"></i> Android':e.match(/ubuntu/gi)?'<span class="os_ubuntu"><i class="fa fa-desktop"></i> Ubuntu':e.match(/linux/gi)?'<span class="os_linux"><i class="fa fa-linux"></i> Linux':e.match(/mac/gi)?'<span class="os_mac"><i class="fa fa-apple"></i> Mac OS X':e.match(/unix/gi)?'<span class="os_unix"><i class="fa fa-desktop"></i> Unix':e.match(/symbian/gi)?'<span class="os_nokia"><i class="fa fa-mobile"></i> Nokia SymbianOS':'<span class="os_other"><i class="fa fa-desktop"></i> 其它操作系统')+"</span>"}!function(T,q,C){function j(e,t){for(var s in t)t[s]&&(e[s]?e[s].set(t[s]):e[s]=new ce(t[s]))}function S(e,t){for(var s in t)e[s]=t[s]}function o(){if(!D.checkPermission())for(var e;e=h.shift();){var t=D.createNotification(e.iconUrl,e.title,e.body),s=e.url;try{t.onclick=function(){T.focus(),Q.href=s,t.cancel()}}catch(e){}t.show(),setTimeout(function(){t.cancel&&t.cancel()},8e3)}}function E(){return 0==pe.data.user_id}function P(e,t,s){if(B)try{B.removeItem(e),B.removeItem(e+":timestamp"),B[e]=c.stringify(t),B[e+":timestamp"]=Math.floor(s)}catch(e){}}function M(e){"none"!=(X.theme=e)&&X.injectStylesheet(J+"/styles/embed"+(e?"."+e+".css?"+p[e]:"."+short_name)+".css")}if(!T.DUOSHUO){function U(e){var t,s,a,i,n,r=this,o=0,d=0;!q.selection||(s=q.selection.createRange())&&s.parentElement()==r&&(i=r.value.length,t=r.value.replace(/\r\n/g,"\n"),(a=r.createTextRange()).moveToBookmark(s.getBookmark()),(n=r.createTextRange()).collapse(!1),-1<a.compareEndPoints("StartToEnd",n)?o=d=i:(o=-a.moveStart("character",-i),o+=t.slice(0,o).split("\n").length-1,-1<a.compareEndPoints("EndToEnd",n)?d=i:(d=-a.moveEnd("character",-i),d+=t.slice(0,d).split("\n").length-1))),$.start=o,$.end=d}function e(e){return function(){return e}}function O(e,t,s,a){X.ajax("GET",e,t,s||function(){},a)}function L(e,t,s,a){X.ajax("POST",e,t,s||function(){},a)}function I(e){if(!("WebSocket"in T&&c))return!1;m.push(c.stringify(e)),s||((s=X.webSocket=new WebSocket("ws://ws.duoshuo.com:8201/")).onopen=function(){var e;if(1===s.readyState)for(;e=m.shift();)s.send(e)},s.onmessage=function(e){try{var t,s=0,a=c.parse(e.data)}catch(e){return}switch(a.type){case"post":for(;s<X.pagelets.length;s++)(t=X.pagelets[s]).threadId==a.thread_id&&t.onMessage(a);break;case"notification":h.push(a),o()}},T.addEventListener("beforeunload",function(){s.close()})),s.onopen()}function N(){for(var e={},t=0;t<arguments.length;t++)arguments[t]&&S(e,arguments[t]);var s=X.param(e);return s?"?"+s:""}function z(){var e=X.getCookie("duoshuo_token");return e?{jwt:e}:H.remote_auth?{short_name:H.short_name,remote_auth:H.remote_auth}:C}function R(){return!H&&(H=T.duoshuoQuery)&&w.trigger("queryDefined"),H}var t,A,s,H,a,i,n,r,Q=T.location,c=T.JSON,u=T.XMLHttpRequest,B=c&&c.stringify&&T.localStorage,D=T.webkitNotifications,d=q.getElementsByTagName("head")[0]||q.getElementsByTagName("body")[0],W=T.navigator.userAgent,l="https:"==q.location.protocol?"https:":"http:",V=0,F=(i={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},n=/&(?!\w+;)|[<>"'`]/g,r=/[&<>"'`]/,function(e){return null==e||!1===e?"":r.test(e)?e.replace(n,k):e}),$={start:0,end:0},p={default:"d6149e1c",dark:"c11b5925",bluebox:"dbc0a9af"},J=l+"//static.duoshuo.com",X=T.DUOSHUO={DOMAIN:"duoshuo.com",REMOTE:"http://duoshuo.com",version:140327,loaded:{jQuery:"undefined"!=typeof jQuery&&"1.5"<=jQuery.fn.jquery,smilies:!1,mzadxN:"undefined"!=typeof mzadxN},libs:{jQuery:J+"/libs/embed.compat.js?24f8ca3f.js",smilies:J+"/libs/smilies.js?921e8eda.js",mzadxN:"http://js.miaozhen.com/mz_ad_serving.js"},sourceName:{weibo:"新浪微博",qq:"QQ",qzone:"QQ空间",qqt:"腾讯微博",renren:"人人网",douban:"豆瓣网",netease:"网易微博",kaixin:"开心网",sohu:"搜狐微博",baidu:"百度",taobao:"淘宝",msn:"MSN",google:"谷歌"},serviceNames:{weibo:"微博",qq:"QQ",douban:"豆瓣",renren:"人人",netease:"网易",kaixin:"开心",sohu:"搜狐",baidu:"百度",taobao:"淘宝",msn:"MSN",google:"谷歌"},parseDate:((a=Date).parse("2011-10-28T00:00:00+08:00")?function(e){return new a(e)}:a.parse("2011/10/28T00:00:00+0800")&&function(e){return new a(e.replace(/-/g,"/").replace(/:(\d\d)$/,"$1"))})||a.parse("2011/10/28 00:00:00+0800")&&function(e){return new a(e.replace(/-/g,"/").replace(/:(\d\d)$/,"$1").replace("T"," "))}||function(e){return new a(e)},fullTime:function(e){var t=X.parseDate(e);return t.getFullYear()+"年"+(t.getMonth()+1)+"月"+t.getDate()+"日 "+t.toLocaleTimeString()},elapsedTime:function(e){var t=X.parseDate(e),s=new Date,a=(s-V-t)/1e3;return a<10?"刚刚":a<60?Math.round(a)+"秒前":a<3600?Math.round(a/60)+"分钟前":a<86400?Math.round(a/3600)+"小时前":(s.getFullYear()==t.getFullYear()?"":t.getFullYear()+"年")+(t.getMonth()+1)+"月"+t.getDate()+"日"},require:function(s,a){if("string"==typeof s)X.loaded[s]?a():f(X.libs[s],function(){X.loaded[s]=!0,a()});else if("object"==typeof s){var e,i=!0;for(e=0;e<s.length;e++)!function(t){X.loaded[s[e]]||(i=!1,f(X.libs[t],function(){X.loaded[t]=!0;for(var e=0;e<s.length;e++)if(!X.loaded[s[e]])return;a()}))}(s[e]);i&&a()}},getCookie:function(e){for(var t,s,a,i=" "+e+"=",n=q.cookie.split(";"),r=0;r<n.length;r++)if(0<=(s=(t=" "+n[r]).indexOf(i))&&s+i.length==(a=t.indexOf("=")+1))return decodeURIComponent(t.substring(a,t.length).replace(/\+/g,""));return C},param:function(e){var t=[];for(var s in e)e[s]!=C&&t.push(s+"="+encodeURIComponent(e[s]));return t.join("&")},ajax:function(e,t,s,r,o){var a=X.getCookie("duoshuo_token");if(s.v=X.version,a?s.jwt=a:H.remote_auth&&(s.remote_auth=H.remote_auth),u&&c&&c.parse){var n=new u;if(n&&"withCredentials"in n){var d;function l(e,t,s){var a,i,n=t;if(200<=e&&e<300||304===e)if(304===e)n="notmodified",a=!0;else try{i=c.parse(s),n="success",a=!0}catch(e){n="parsererror",0}else{n&&!e||(n="error",e<0&&(e=0));try{i=c.parse(s)}catch(e){n="parsererror",0}}a?r(i):"parseerror"===n?ie("解析错误: "+s):(o&&o(i),ie("出错啦("+i.code+"): "+i.errorMessage),i.errorTrace&&ie(i.errorTrace))}return n.open(e,X.hostUrl+t+".json"+("GET"==e?"?"+X.param(s):""),!0),n.withCredentials=!0,n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),n.send("GET"==e?null:X.param(s)),d=function(e,t){var s,a,i;try{if(d&&(t||4===n.readyState))if(d=C,t)4!==n.readyState&&n.abort();else{s=n.status,n.getAllResponseHeaders();try{i=n.responseText}catch(e){}try{a=n.statusText}catch(e){a=""}}}catch(e){t||l(-1,e)}i&&l(s,a,i)},void(4===n.readyState?d():n.onreadystatechange=d)}}"GET"!=e&&(s._method="POST");var i="cb_"+Math.round(1e6*Math.random());X[i]=function(e){switch(e.code){case 0:r(e);break;default:o&&o(e),ie("出错啦("+e.code+"): "+e.errorMessage),e.errorTrace&&ie(e.errorTrace)}},s.callback="DUOSHUO['"+i+"']",f(X.hostUrl+t+".jsonp?"+X.param(s))},injectStylesheet:function(e){var t=q.createElement("link");t.type="text/css",t.rel="stylesheet",t.href=e,d.appendChild(t)},setCustomStyle:function(e){if(t||((t=q.createElement("style")).type="text/css",d.appendChild(t)),e=e.replace(/\}/g,"}\n"),t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(q.createTextNode(e))}},compileStyle:function(e){var t="",s={textbox:"#ds-thread #ds-reset .ds-replybox .ds-textarea-wrapper"};if(e)for(var a in e)t+=s[a]+"{"+e[a]+"}\n";return t},init:function(e,t){e&&!Z[e]&&(Z[e]=t||{type:"EmbedThread"}),X.initView&&X.initView()}},G=q.all,Y=X.support=function(){var e=q.createElement("div");e.innerHTML='<a href="/a">a</a><input type="checkbox"/>';var t=e.getElementsByTagName("a")[0],s={placeholder:"placeholder"in e.getElementsByTagName("input")[0],touch:"ontouchstart"in T||"onmsgesturechange"in T,hrefNormalized:"/a"===t.getAttribute("href"),iOS:W.match(/ \((iPad|iPhone|iPod);( U;)? CPU( iPhone)? OS /),android:W.match(/ \(Linux; U; Android /)};return A=!u&&void 0===e.style.maxHeight,s.authInWin=T.postMessage&&800<T.screen.width&&!s.iOS&&!s.android&&Q.origin,s}(),Z=X.selectors={".ds-thread":{type:"EmbedThread"},".ds-recent-comments":{type:"RecentComments"},".ds-recent-visitors":{type:"RecentVisitors"},".ds-top-users":{type:"TopUsers"},".ds-top-threads":{type:"TopThreads"},".ds-login":{type:"LoginWidget"},".ds-thread-count":{type:"ThreadCount"}},K=X.pagelets=[],ee={post:"发布",posting:"正在发布",settings:"设置",reply:"回复",like:"顶",repost:"转发",report:"举报",delete:"删除",reply_to:"回复 ",reposts:"转发",comments:"评论",floor:"楼",latest:"最新",earliest:"最早",hottest:"最热",share_to:"分享到:",leave_a_message:"说点什么吧…",no_comments_yet:"还没有评论，沙发等你来抢",repost_reason:"请输入转发理由",hot_posts_title:"被顶起来的评论",comments_zero:"暂无评论",comments_one:"1条评论",comments_multiple:"{num}条评论",reposts_zero:"暂无转发",reposts_one:"1条转发",reposts_multiple:"{num}条转发",weibo_reposts_zero:"暂无新浪微博",weibo_reposts_one:"1条新浪微博",weibo_reposts_multiple:"{num}条新浪微博",qqt_reposts_zero:"暂无腾讯微博",qqt_reposts_one:"1条腾讯微博",qqt_reposts_multiple:"{num}条腾讯微博"},h=[],m=[],te=X.Collections={},se=X.Views={},ae=(X.Callbacks={},X.openDialog=function(e){return X.dialog!==C&&X.dialog.el.remove(),X.dialog=new se.Dialog('<div class="ds-dialog"><div class="ds-dialog-inner ds-rounded"><div class="ds-dialog-body">'+e+'</div><div class="ds-dialog-footer"><a href="http://duoshuo.com/" target="_blank" class="ds-logo"></a><span>社会化评论框</span></div><a class="ds-dialog-close" href="javascript:void(0)" title="关闭"></a></div></div>').open()}),f=X.injectScript=function(e,s){var a=q.createElement("script"),i=q.head||q.getElementsByTagName("head")[0]||q.documentElement;a.type="text/javascript",a.src=e,a.async="async",a.charset="utf-8",s&&(a.onload=a.onreadystatechange=function(e,t){!t&&a.readyState&&!/loaded|complete/.test(a.readyState)||(a.onload=a.onreadystatechange=null,i&&a.parentNode&&i.removeChild(a),a=C,t||s.call(T))}),i.insertBefore(a,i.firstChild)},ie=X.log=function(e){"object"==typeof console&&console.log(e)},ne=X.smilies={},v=["EmbedThread","RecentComments","RecentVisitors","TopUsers","TopThreads","LoginWidget","ThreadCount"],g=0;for(var b in Object.prototype)return alert("Object.prototype不为空，请不要给Object.prototype设置方法");function re(e){var t=[];for(var s in e)t.push('<input type="hidden" name="'+s+'" value="'+F(e[s])+'" />');return t.join("\n")}for(var oe=X.templates={userUrl:function(e){return e.url},avatarUrl:function(e,t){return e.avatar_url||ue.data.default_avatar_url},userAnchor:function(e){var t=oe.userUrl(e);return t?'<a rel="nofollow author" target="_blank" href="'+F(t)+'">'+F(e.name)+"</a>":F(e.name)},avatarImg:function(e,t){return'<img src="'+F(oe.avatarUrl(e,t))+'" alt="'+F(e.name)+'"'+(t?' style="width:'+t+"px;height:"+t+'px"':"")+"/>"},avatar:function(e,t){var s=oe.avatarImg(e,t),a=oe.userUrl(e);return a?'<a rel="nofollow author" target="_blank" href="'+F(a)+'" '+(e.user_id?" onclick=\"this.href='"+X.hostUrl+"/user-url/?user_id="+e.user_id+"';\"":"")+' title="'+F(e.name)+'">'+s+"</a>":s},timeHtml:function(e,t){return e?t?'<a href="'+t+'" target="_blank" rel="nofollow" class="ds-time" datetime="'+e+'" title="'+X.fullTime(e)+'">'+X.elapsedTime(e)+"</a>":'<span class="ds-time" datetime="'+e+'" title="'+X.fullTime(e)+'">'+X.elapsedTime(e)+"</span>":""},serviceIcon:function(e,t){return'<a href="javascript:void(0)" class="ds-service-icon'+(t?"-grey":"")+" ds-"+e+'" data-service="'+e+'" title="'+X.sourceName[e]+'"></a>'},loginButtons:function(e){return'<div class="ds-login-buttons"><p>社交帐号登录:</p><div class="ds-social-links">'+oe.serviceList()+oe.additionalServices()+"</div></div>"},poweredBy:function(e){return'<p class="ds-powered-by"><a href="http://duoshuo.com" target="_blank" rel="nofollow">'+F(e)+"</a></p>"},indicator:e('<div id="ds-indicator"></div>'),waitingImg:e('<div id="ds-waiting"></div>'),serviceList:function(e){for(var t='<ul class="ds-service-list">',s=["weibo","qq","renren","douban"],a=0;a<s.length;a++)t+=oe.loginItem(s[a],e);return t+'<li><a class="ds-more-services" href="javascript:void(0)">更多»</a></li></ul>'},additionalServices:function(e){for(var t='<ul class="ds-service-list ds-additional-services">',s=["kaixin","netease","sohu","baidu","google"],a=0;a<s.length;a++)t+=oe.loginItem(s[a],e);return t+"</ul>"},loginItem:function(e,t){return'<li><a href="'+oe[t?"bindUrl":"loginUrl"](e)+'" rel="nofollow" class="ds-service-link ds-'+e+'">'+X.serviceNames[e]+(pe.data.social_uid[e]?' <span class="ds-icon ds-icon-ok"></span>':"")+"</a></li>"},loginUrl:function(e,t){return t=t||{},H.sso&&H.sso.login&&(t.sso=1,t.redirect_uri=H.sso.login),X.hostUrl+"/login/"+e+"/"+N(t)},bindUrl:function(e){return X.hostUrl+"/bind/"+e+"/"+N(H.sso&&H.sso.login?{sso:1,redirect_uri:H.sso.login}:null,z())},logoutUrl:function(){return X.hostUrl+"/logout/"+N(H.sso&&H.sso.logout?{sso:1,redirect_uri:H.sso.logout}:null)},likePost:function(e){return'<a class="ds-post-likes" href="javascript:void(0);"><span class="ds-icon ds-icon-like"></span>'+ee.like+(0<e.likes?"("+e.likes+")":"")+"</a>"},ctxPost:function(e,t,s){var a=de(e);return'<li class="ds-ctx-entry"'+(s?' style="display:none"':"")+' data-post-id="'+e.post_id+'"><div class="ds-avatar">'+oe.avatar(a)+'</div><div class="ds-ctx-body"><div class="ds-ctx-head">'+oe.userAnchor(a)+oe.timeHtml(e.created_at,e.url)+(0<=t?'<div class="ds-ctx-nth" title="'+X.fullTime(e.created_at)+'">'+(t+1)+ee.floor+"</div>":"")+'</div><div class="ds-ctx-content">'+e.message+(0<=t?'　　　　　　　<div class="ds-comment-actions'+(0<e.vote?" ds-post-liked":"")+'">'+oe.likePost(e)+' <a class="ds-post-repost" href="javascript:void(0);"><span class="ds-icon ds-icon-share"></span>'+ee.repost+'</a> <a class="ds-post-reply" href="javascript:void(0);"><span class="ds-icon ds-icon-reply"></span>'+ee.reply+"</a></div>":"")+"</div></div></li>"}},de=function(e){return ve[e.author_id]&&ve[e.author_id].data||e.author};g<v.length;g++)X[v[g]]=function(s){return function(e,t){(t=t||{}).type=s,e&&!Z[e]&&(Z[e]=t),X.initSelector&&X.initSelector(e,t)}}(v[g]),X["create"+v[g]]=function(i){return function(e,t){var s=q.createElement(e);for(var a in t)s.setAttribute("data-"+a,t[a]);return X[i](s),s}}(v[g]);X.RecentCommentsWidget=X.RecentComments;var _=0,y=X.Class=function(){};y.extend=function(e){function t(){!_&&this.init&&this.init.apply(this,arguments)}_=1;var s=new this;for(var a in _=0,e)s[a]=e[a];return((t.prototype=s).constructor=t).extend=arguments.callee,t};var le=X.Event=y.extend({on:function(e,t){var s=this.handlers||(this.handlers={});return s[e]===C&&(s[e]=[]),s[e].push(t),this},trigger:function(e,t){var s=(this.handlers||(this.handlers={}))[e];if(s)for(var a=0;a<s.length&&!1!==s[a].call(this,t);a++);return this}}),ce=X.Model=le.extend({init:function(e){this.data=e},reset:function(e){this.data=e,this.trigger("reset")},remove:function(e){this.data.splice(e,1),this.trigger("reset")},set:function(e,t){if(t===C)for(var s in e)this.data[s]=e[s];else this.data[e]=t;this.trigger("reset")}}),w=X.events=new le,ue=X.site=new ce,pe=X.visitor=new ce,he=X.unread=new ce,me=X.threads={},fe=X.postPool={},ve=X.users={};w.on("queryDefined",function(){var e=H.short_name;if(X.hostUrl=e?l+"//"+e+"."+X.DOMAIN:X.REMOTE,H.theme&&M(H.theme),B){var t=B["ds_site_"+e],s=B["ds_lang_"+e];t&&ue.reset(c.parse(t)),s&&S(ee,c.parse(s))}}),R(),X.loaded.jQuery&&(X.jQuery=T.jQuery),X.require("jQuery",function(){function v(e,t,s){if(!e.find(".ds-post[data-post-id="+t.post_id+"]")[0])return e.find(".ds-post-placeholder").remove(),y(oe.post(t,s)).hide()["asc"==s.order?"appendTo":"prependTo"](e).slideDown(function(){})}function t(l,i){var n;this.delegate("a.ds-post-likes","click",function(e){if(E())return t=ae("<h2>社交帐号登录</h2>"+oe.serviceList()+oe.additionalServices()).el.find(".ds-dialog").css("width","300px"),w(t),!1;var t,s=y(this).parent();return liked=s.hasClass("ds-post-liked"),matches=y(this).html().match(/\((\d+)\)/),likes=(matches?parseInt(matches[1]):0)+(liked?-1:1),L("/api/posts/vote",{post_id:s.closest(".ds-ctx-entry, .ds-post-self").attr("data-post-id"),vote:liked?0:1}),y(this).html(y(this).html().replace(/\(\d+\)/,"")+(likes?"("+likes+")":"")),s[liked?"removeClass":"addClass"]("ds-post-liked"),!1}).delegate("a.ds-post-repost","click",function(e){var t=y(this).closest(".ds-post-self"),s=fe[t.attr("data-post-id")];return X.repostDialog(s,""),!1}).delegate("a.ds-post-delete","click",function(e){if(confirm("确定要删除这条评论吗？")){var t=y(this).closest(".ds-post-self");L("/api/posts/remove",{post_id:t.attr("data-post-id")}),t.parent().fadeOut(200,function(){l.data.comments--,l.updateCounter("duoshuo"),y(this).remove()})}return!1}).delegate("a.ds-post-report","click",function(e){if(confirm("确定要举报这条评论吗？")){var t=y(this).closest(".ds-post-self");L("/api/posts/report",{post_id:t.attr("data-post-id")}),alert("感谢您的反馈！")}return!1}).delegate("a.ds-post-reply","click",function(e){var t=y(this),s=t.closest(".ds-comment-actions");if(s.hasClass("ds-reply-active"))n.el.fadeOut(200,function(){y(this).detach()}),s.removeClass("ds-reply-active");else{var a=t.closest(".ds-ctx-entry, .ds-post-self");n?n.actionsBar.removeClass("ds-reply-active"):(n=new se.Replybox(l)).render(!0).el.addClass("ds-inline-replybox").detach(),n.el.find("[name=parent_id]").val(a.attr("data-post-id")),n.el.show().appendTo(t.closest(".ds-ctx-body, .ds-comment-body")).find("textarea").focus(),n.actionsBar=s.addClass("ds-reply-active"),i.max_depth<=1?n.postList=l.postList.el:(n.postList=a.siblings(".ds-children"),n.postList[0]||(n.postList=y('<ul class="ds-children"></ul>').insertAfter(a)))}return!1}).delegate("a.ds-weibo-comments","click",function(e){var t=y(this).closest(".ds-post-self"),s=t.attr("data-post-id");t.data("source");if(0==t.attr("data-root-id")){var a=t.siblings(".ds-children");a[0]?a.remove():(a=y('<ul class="ds-children"></ul>').insertAfter(t),O("/api/posts/listComments",c({post_id:s}),function(e){p(e),a.append(y.map(e.response,function(e){return oe.post(e,i)}).join(""))}))}return!1}).delegate("a.ds-weibo-reposts","click",function(e){var t=y(this).closest(".ds-post-self"),s=fe[t.attr("data-post-id")],a=s.data.source;if(pe.data.social_uid["qqt"==a?"qq":a]){var i=s.data.root_id,n="0"!=i?fe[i]:s,r="";if("0"!=i){var o=de(s.data);r=("weibo"==a?"//@"+o.name:"|| @"+o.qqt_account)+":"+s.data.message}return X.repostDialog(n,r,l,a),!1}d(a)}).delegate("a.ds-expand","click",function(e){var t=y(this).parent();return t.siblings().show(),t.remove(),!1}),Y.touch||this.delegate("a.ds-comment-context, .ds-avatar, .ds-user-name","mouseenter",function(e){var o=this;if(bubbleOutTimer&&f.owner==o)clearTimeout(bubbleOutTimer),bubbleOutTimer=0;else{var d=y(o);x=setTimeout(function(){x=0,f.owner=o,m();var e=d.offset(),t=l.el.offset(),s=d.innerWidth()/2,a=l.el.innerHeight()-(e.top-t.top)+6,i=e.left-t.left-35+(35<s?35:s);try{if(d.hasClass("ds-comment-context"))k.attr("id","ds-ctx-bubble").attr("data-post-id",d.attr("data-post-id")).html('<ul id="ds-ctx">'+oe.ctxPost(fe[d.attr("data-parent-id")].data)+'</ul><div class="ds-bubble-footer"><a class="ds-ctx-open" href="javascript:void(0);">查看对话</a></div>');else if(d.hasClass("ds-avatar")||d.hasClass("ds-user-name")){var n={},r=n.user_id=d.attr("data-user-id");if(!r)throw"no info";k.attr("id","ds-user-card").attr("data-user-id",r).empty(),ve[r]?k.html(oe.userInfo(ve[r].data)):O("/api/users/profile",c(n),function(e){var t=e.response;ve[r]?ve[r].set(t):ve[r]=new ce(t),f.owner==o&&k.html(oe.userInfo(t))})}f.css({bottom:a,left:i}).appendTo(l.innerEl)}catch(e){f.detach()}},200)}}).delegate("a.ds-comment-context, .ds-avatar, .ds-user-name","mouseleave",function(){x?(clearTimeout(x),x=0):bubbleOutTimer||bubbleOut()})}function d(e){var t=oe[E()?"loginUrl":"bindUrl"](e);Y.authInWin&&s(e,t)||(Q.href=t)}function c(e){var t={require:"site,visitor,nonce,serverTime,lang"+(r++?"":",unread,log,extraCss"),site_ims:B&&B["ds_site_"+H.short_name+":timestamp"],lang_ims:B&&B["ds_lang_"+H.short_name+":timestamp"],referer:q.referrer};for(var s in H.stylePatch&&(t.style_patch=H.stylePatch),t)t[s]&&(!A||encodeURIComponent(t[s]).length<200)&&(e[s]=t[s]);return e}function l(e){e.stopPropagation()}function g(e){(e.ctrlKey&&13==e.which||10==e.which)&&y(this.form).trigger("submit")}function b(e){var t=y(this);t.height(Math.max(54,t.next(".ds-hidden-text").text(this.value).height()+27))}function u(e){return Y.touch&&e.addClass("ds-touch"),function(e,t){var s=(q.body||q.documentElement).style;if(void 0===s)return!1;if("string"==typeof s[e])return!t||e;for(var a=["Moz","Webkit","ms"],i=(e=e.charAt(0).toUpperCase()+e.substr(1),0);i<a.length;i++)if("string"==typeof s[a[i]+e])return!t||a[i]+e}("transition")||e.addClass("ds-no-transition"),A&&e.addClass("ds-ie6"),y.support.opacity||e.addClass("ds-no-opacity"),e}function _(e){if(!Y.placeholder){var t=e.attr("placeholder");e.val(t).focus(function(){this.value===t&&(this.value="")}).blur(function(){""===this.value&&(this.value=t)})}return e}var y=X.jQuery,i=y(T),n=y(q),p=X.loadRequire=function(e){if(e.serverTime&&(V=(new Date).getTime()-1e3*e.serverTime),e.visitor&&(!pe.data&&e.visitor.user_id&&D&&!D.checkPermission()&&I({logged_user_id:e.visitor.user_id}),pe.reset(e.visitor)),e.site&&(ue.reset(e.site),P("ds_site_"+H.short_name,e.site,e.serverTime)),!X.theme&&ue.data.theme&&M(ue.data.theme),e.lang&&(S(ee,e.lang),P("ds_lang_"+H.short_name,e.lang,e.serverTime)),e.stylesheets)for(var t=0;t<e.stylesheets.length;t++)X.injectStylesheet(e.stylesheets[t]);e.nonce&&(X.nonce=e.nonce),e.style&&X.setCustomStyle((e.style||"")+X.compileStyle(H.component_style)),e.unread&&he.reset(e.unread)},s=function(e,t){var s={weibo:[760,600],renren:[420,322],qq:[504,445],netease:[810,645],sohu:[972,600],google:[600,440],taobao:[480,585]}[e]||[550,400];return T.open(t+(-1==t.indexOf("?")?"?":"&")+X.param({origin:Q.origin||"http://"+Q.host}),"_blank","width="+s[0]+",height="+s[1]+",toolbar=no,menubar=no,location=yes")},w=function(e,t){Y.authInWin&&e.find(t||"a.ds-service-link").click(function(e){var t=this.href.match(/\/(login|bind)\/(\w+)\//i);if(t&&X.serviceNames[t[2]])return!s(t[2],this.href)})};if(T.postMessage){function e(e){if("http://duoshuo.com"===e.origin)switch(e.data.type){case"login":Q.href=e.data.redirectUrl}}T.addEventListener?T.addEventListener("message",e,!1):T.attachEvent&&T.attachEvent("onmessage",e)}X.scrollTo=function(e){var t=e.offset().top;(t<i.scrollTop()||t>i.scrollTop()+i.height())&&y("html, body").animate({scrollTop:t-40},200,"swing")},X.toJSON=function(e){var a=/\r?\n/g,t=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,s=/^(?:select|textarea)/i,i=e.map(function(){return this.elements?y.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||s.test(this.nodeName)||t.test(this.type))}).map(function(e,s){var t=y(this).val();return null==t?null:y.isArray(t)?y.map(t,function(e,t){return{name:s.name,value:e.replace(a,"\r\n")}}):{name:s.name,value:t.replace(a,"\r\n")}}).toArray(),n={};return y.each(i,function(){n[this.name]=this.value}),n};function h(e){var t={"unread-comments":{title:"新留言及回复",apiUrl:"/api/users/unreadComments",tmpl:function(e){return'<li data-thread-id="'+e.thread.thread_id+'">'+y.map(e.authors,oe.userAnchor).join("、")+' 在 <a class="ds-read" href="'+e.thread.url+'#comments" target="_blank">'+F(e.thread.title||"无标题")+'</a> 中回复了你 <a class="ds-delete ds-read" title="知道了" href="javascript:void(0)">知道了</a></li>'},read:function(e){var t=e.attr("data-thread-id");L("/api/threads/read",{thread_id:t}),he.data.comments--}},"unread-notifications":{title:"系统消息",apiUrl:"/api/users/unreadNotifications",tmpl:function(e){return'<li data-notification-id="'+e.notification_id+'" data-notification-type="'+e.type+'">'+e.content+' <a class="ds-delete ds-read" title="知道了" href="javascript:void(0)">知道了</a></li>'},read:function(e){var t=e.attr("data-notification-id");L("/api/notifications/read",{notification_id:t}),he.data.notifications--}}}[e],s=ae("<h2>"+t.title+'</h2><ul class="ds-unread-list"></ul>');s.on("close",X.resetNotify);var a=s.el.find(".ds-unread-list").delegate(".ds-delete","click",function(e){return y(this).parent().remove(),0===a.children().length&&s.close(),!1}).delegate(".ds-read","click",function(e){t.read(y(this).parent())});y("#ds-notify").hide(),O(t.apiUrl,{},function(e){s.el.find(".ds-unread-list").html(y.map(e.response,t.tmpl).join("\n"))}),D&&D.checkPermission()&&D.requestPermission(o)}var a=X.Widget=le.extend({init:function(e,t){this.el=e,this.options=t||{},this.render()},render:function(){},reset:function(){},load:function(e){switch(e.code){case 0:p(e),this.onload(e);break;default:this.onError(e)}},onload:function(e){this.el.html(oe[this.tmpl].call(oe,e.response,y.extend(this.options,e.options)))},onMessage:function(){},onError:function(e){ie("出错啦("+e.code+"): "+e.errorMessage),e.errorTrace&&ie(e.errorTrace)}});X.resetNotify=function(){var e=y("#ds-notify"),t=he.data;e[0]||(e=y('<div id="ds-notify"></div>').css({hidden:{display:"none"},"top-right":{top:"24px",right:"24px"},"bottom-right":{bottom:"24px",right:"24px"}}[ue.data.notify_position]).delegate(".ds-notify-unread a","click",function(e){return h(y(this).data("type")),!1}).appendTo(q.body)),e.html('<div id="ds-reset"><a class="ds-logo" href="http://duoshuo.com/" target="_blank" title="多说"></a><ul class="ds-notify-unread"><li'+(t.comments?"":' style="display:none;"')+'><a data-type="unread-comments" href="javascript:void(0);">你有'+t.comments+"条新回复</a></li><li"+(t.notifications?"":' style="display:none;"')+'><a data-type="unread-notifications" href="javascript:void(0);">你有'+t.notifications+"条系统消息</a></li></ul></div>")[!t.comments&&!t.notifications||"hidden"===ue.data.notify_position||y(".ds-dialog")[0]?"hide":"show"]()},he.on("reset",X.resetNotify),oe.replybox=function(e,t){var s,a=e.options,i=pe.data,n=[],r="",o={thread_id:e.threadId,parent_id:"",nonce:X.nonce};for(var d in i.repostOptions)i.repostOptions[d]&&(n.push(d),s=1),r+=oe.serviceIcon(d,!i.repostOptions[d]);return'<div class="ds-replybox"><a class="ds-avatar"'+(E()?' href="javascript:void(0);" onclick="return false"':' href="'+X.REMOTE+"/settings/avatar/"+N(z())+'" target="_blank" title="设置头像"')+">"+oe.avatarImg(i)+'</a><form method="post">'+re(o)+'<div class="ds-textarea-wrapper ds-rounded-top"><textarea name="message" title="Ctrl+Enter快捷提交" placeholder="'+F(ee.leave_a_message)+'"></textarea><pre class="ds-hidden-text"></pre></div><div class="ds-post-toolbar"><div class="ds-post-options ds-gradient-bg"><span class="ds-sync">'+(!E()&&r?'<input id="ds-sync-checkbox'+(t?"-inline":"")+'" type="checkbox" name="repost" '+(s?'checked="checked" ':"")+'value="'+n.join(",")+'"> <label for="ds-sync-checkbox'+(t?"-inline":"")+'">'+ee.share_to+"</label>"+r:"")+'</span></div><button class="ds-post-button" type="submit">'+F(ee.post)+'</button><div class="ds-toolbar-buttons">'+(a.use_smilies?'<a class="ds-toolbar-button ds-add-emote" title="插入表情"></a>':"")+(a.use_images&&a.parse_html_enabled?'<a class="ds-toolbar-button ds-add-image" title="插入图片"></a>':"")+"</div></div></form></div>"},se.Replybox=function(e){this.embedThread=e},se.Replybox.prototype={render:function(e){function a(e){e.data("submitting",!1),e.find(".ds-post-button").removeClass("ds-waiting").html(ee.post)[0].disabled=!1}function t(e){X.require("smilies",function(){})}function s(e,s){var a=ae('<h2>社交帐号登录</h2><div class="ds-icons-32">'+y.map(["weibo","qq","renren","kaixin","douban","netease","sohu"],function(e){return'<a class="ds-'+e+'" href="'+oe.loginUrl(e)+'">'+X.sourceName[e]+"</a>"}).join("")+"</div>"+(r.deny_anonymous?"":'<h2>作为游客留言</h2><form><div class="ds-control-group"><input type="text" name="author_name" id="ds-dialog-name" value="'+F(pe.data.name)+'" required /><label for="ds-dialog-name">名字(必填)</label></div>'+(r.require_guest_email?'<div class="ds-control-group"><input type="email" name="author_email" id="ds-dialog-email" value="'+F(pe.data.email)+'" required /><label for="ds-dialog-email">邮箱(必填)</label></div>':"")+(r.require_guest_url?'<div class="ds-control-group"><input type="url" name="author_url" id="ds-dialog-url" placeholder="http://" value="'+F(pe.data.url||"")+'" /><label for="ds-dialog-url">网址(可选)</label></div>':"")+'<button type="submit">发布</button></form>')),t=a.el.find(".ds-dialog").css("width","320px");if(w(t,".ds-icons-32 a"),!r.deny_anonymous){var i=a.el.find("form");i.submit(function(e){var t=i.find("input[name=author_email]").val();return!t&&!r.require_guest_email||t.match(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)?(s(X.toJSON(i)),a.close()):alert("请输入一个有效的email地址."),!1}),i.find("input[name=author_name]")[0].focus()}}var i=this,n=i.embedThread,r=n.options,o=i.el=y(oe.replybox(n,e)).click(t),d=o.find("form"),l=d.find("input[type=checkbox]")[0],c=d.find("a.ds-service-icon, a.ds-service-icon-grey"),u=_(d.find("textarea")).focus(t).keyup(g).keyup(b).bind("focus mousedown mouseup keyup",U),p=o.find(".ds-add-emote").click(function(e){var t=X.smiliesTooltip;return p.toggleClass("ds-expanded").hasClass("ds-expanded")?(t||((t=X.smiliesTooltip=new se.SmiliesTooltip).render(),X.require("smilies",function(){t.reset("微博-默认")})),t.replybox=i,t.el.appendTo(q.body).css({top:i.el.offset().top+i.el.outerHeight()+4+"px",left:i.el.find(".ds-textarea-wrapper").offset().left+"px"}),y(q.body).click(h)):h(e),!1}),h=(o.find(".ds-add-image").click(function(e){var t=u[0],s=t.value,a="请输入图片地址",i='<img src="'+a+'" />';if(q.selection){t.value=s.substring(0,$.start)+i+s.substring($.end,s.length),t.value=t.value.replace("说点什么吧 ...",""),t.focus();var n=q.selection.createRange();n.collapse(),n.findText(a),n.select()}else{t.value=s.substring(0,t.selectionStart)+i+s.substring(t.selectionEnd);var r=t.value.search(a);t.setSelectionRange(r,r+a.length),t.focus()}e.preventDefault()}),i.hideSmilies=function(e){p.removeClass("ds-expanded"),X.smiliesTooltip.el.detach(),y(q.body).unbind("click",h)});r.deny_anonymous&&u.focus(function(e){if(E()){s(0,m);var t=function(e){e.stopPropagation(),u.unbind("click",t)};u.click(t)}return!1});var m=function(e){var t;(t=d).data("submitting",!0),t.find(".ds-post-button").addClass("ds-waiting").html(ee.posting)[0].disabled=!0,L("/api/posts/create",y.extend(X.toJSON(d),e),function(e){var t=e.response,s=v(i.postList,t,r);if("asc"==r.order==("top"==r.formPosition)&&X.scrollTo(s),fe[t.post_id]=new ce(t),n.data.comments++,n.updateCounter("duoshuo"),u.val("").trigger("keyup"),a(d),o.hasClass("ds-inline-replybox")&&(o.detach(),i.actionsBar.removeClass("ds-reply-active")),B)try{B.removeItem("ds_draft_"+n.threadId)}catch(e){}},function(e){a(d),alert(e.errorMessage)})};d.submit(function(e){if(d.data("submitting"))return!1;var t=y.trim(d[0].message.value);return""==t||!Y.placeholder&&t==u.attr("placeholder")?alert("您还没写内容呢"):E()?s(0,m):m(),!1});function f(e){return y(e).hasClass("ds-service-icon-grey")?null:y(e).attr("data-service")}return c.click(function(){return y(this).toggleClass("ds-service-icon-grey").toggleClass("ds-service-icon"),l.value=y.map(c,f).join(","),l.checked=""!=l.value,!1}),y(l).change(function(){var e=this.checked;c[e?"removeClass":"addClass"]("ds-service-icon-grey")[e?"addClass":"removeClass"]("ds-service-icon"),this.value=y.map(c,f).join(",")}),this}},se.Dialog=le.extend({init:function(e,t){(this.el=y("#ds-wrapper"))[0]||(this.el=u(y('<div id="ds-wrapper"></div>'))),this.options=y.extend({width:600},t),e!==C&&y(e).attr("id","ds-reset").appendTo(this.el)},open:function(){var t=this;t.el.hide().appendTo(q.body).fadeIn(200),A&&t.el.css("top",i.scrollTop()+100),t.el.show().find(".ds-dialog").delegate("a.ds-dialog-close","click",function(e){return t.close(),!1}).click(l);function s(e){if(27==e.which)return t.close(),!1}function a(e){return t.close(),!1}return n.keydown(s),y(q.body).click(a),t.close=function(e){n.unbind("keydown",s),y(q.body).unbind("click",a),t.el.fadeOut(200,function(){y(this).remove()}),t.trigger("close")},t}}),oe.likePanel=function(e){return e.likes?'<span class="ds-highlight">'+e.likes+"</span> 人喜欢":""},oe.likeTooltip=function(e){var t={qzone:"QQ空间",weibo:"新浪微博",qqt:"腾讯微博",renren:"人人网",kaixin:"开心网",douban:"豆瓣网",baidu:"百度搜藏",netease:"网易微博",sohu:"搜狐微博"},s=[];for(var a in t)s.push('<li><a class="ds-share-to-'+a+" ds-service-link ds-"+a+'" href="'+X.hostUrl+"/share-proxy/?"+X.param({service:a,thread_id:e.thread_id})+'">'+t[a]+"</a></li>");var i=Math.ceil(s.length/2);return'<div class="ds-like-tooltip ds-rounded"><p>很高兴你能喜欢，分享一下吧：</p><ul>'+s.slice(0,i).join("")+"</ul><ul>"+s.slice(i).join("")+'</ul><p class="ds-like-tooltip-footer"><a class="ds-like-tooltip-close">算了</a></p></div>'},se.Meta=function(e){this.embedThread=e},se.Meta.prototype={render:function(){var a=this,i=a.embedThread,n=i.data,r=a.el=y('<div class="ds-meta"><a href="javascript:void(0)" class="ds-like-thread-button ds-rounded'+(0<n.user_vote?" ds-thread-liked":"")+'"><span class="ds-icon ds-icon-heart"></span> <span class="ds-thread-like-text">'+(0<n.user_vote?"已喜欢":"喜欢")+'</span><span class="ds-thread-cancel-like">取消喜欢</span></a><span class="ds-like-panel"></span></div>'),o=r.find(".ds-like-thread-button").click(function(e){var t=o.hasClass("ds-thread-liked");L("/api/threads/vote",{thread_id:i.threadId,vote:t?0:1},function(e){y.each(e.response.thread,function(e,t){n[e]=t}),a.resetLikePanel()}),o.toggleClass("ds-thread-liked"),o.find(".ds-thread-like-text").text(t?"喜欢":"已喜欢");var s=function(e){a.tooltip.detach(),y(q.body).unbind("click",s)};return t?a.tooltip&&s(e):(a.tooltip===C&&(a.tooltip=y(oe.likeTooltip(n)).click(l).delegate("a","click",function(e){switch(this.className){case"ds-like-tooltip-close":s(e);break;default:if(!T.open(this.href,"_blank","height=500,width=600,top=0,left=0,toolbar=no,menubar=no,resizable=yes,location=yes,status=no"))return}return!1})),a.tooltip.appendTo(i.innerEl).css({top:r.position().top+r.outerHeight()-4+"px",left:0}),y(q.body).click(s)),!1});return a.resetLikePanel(),E()&&r.hide(),a},resetLikePanel:function(){this.el.find(".ds-like-panel").html(oe.likePanel(this.embedThread.data))}},oe.postListHead=function(e){var t=e.data,s=e.options;return'<div class="ds-comments-info"><div class="ds-sort"><a class="ds-order-desc">'+ee.latest+'</a><a class="ds-order-asc">'+ee.earliest+'</a><a class="ds-order-hot">'+ee.hottest+'</a></div><ul class="ds-comments-tabs"><li class="ds-tab"><a class="ds-comments-tab-duoshuo ds-current" href="javascript:void(0);"></a></li>'+(s.show_reposts&&t.reposts?'<li class="ds-tab"><a class="ds-comments-tab-repost" href="javascript:void(0);"></a></li>':"")+(s.show_weibo&&t.weibo_reposts?'<li class="ds-tab"><a class="ds-comments-tab-weibo" href="javascript:void(0);"></a></li>':"")+(s.show_qqt&&t.qqt_reposts?'<li class="ds-tab"><a class="ds-comments-tab-qqt" href="javascript:void(0);"></a></li>':"")+"</ul></div>"},se.PostListHead=function(e){this.embedThread=e},se.PostListHead.prototype={render:function(){var s=this.embedThread,t=s.options,a=s.postList,e=this.el=y(oe.postListHead(s)),i=e.find("ul.ds-comments-tabs").delegate(".ds-tab a","click",function(e){i.find("a.ds-current").removeClass("ds-current"),a.params.page=1;var t=e.currentTarget;switch(t.className){case"ds-comments-tab-duoshuo":a.params.source="duoshuo",s.replybox.el.show();break;case"ds-comments-tab-repost":a.params.source="repost",s.replybox.el.hide();break;case"ds-comments-tab-weibo":a.params.source="weibo",s.replybox.el.hide();break;case"ds-comments-tab-qqt":a.params.source="qqt",s.replybox.el.hide()}return y(t).addClass("ds-current"),a.refetch(),!1}),n=e.find(".ds-sort").delegate("a","click",function(e){return n.find("a.ds-current").removeClass("ds-current"),a.params.order=t.order=this.className.replace("ds-order-",""),a.params.page=1,a.refetch(),y(this).addClass("ds-current"),!1});return n.find(".ds-order-"+a.params.order).addClass("ds-current"),this}},se.Paginator=function(e){e=e||{};var t=this.el=e.el||y('<div class="ds-paginator"></div>'),s=this.collection=e.collection;t.delegate("a","click",function(e){return s.params.page=parseInt(this.innerHTML),s.refetch(),t.find(".ds-current").removeClass("ds-current"),y(this).addClass("ds-current"),!1})},se.Paginator.prototype={reset:function(e){function t(e){i.push('<a data-page="'+e+'" href="javascript:void(0);">'+e+"</a>")}var s,a=this.collection.params.page||1,i=[];if(1<a)for(t(1),2<(s=4<a?a-2:2)&&i.push('<span class="page-break">...</span>');s<a;s++)t(s);if(i.push('<a data-page="'+a+'" href="javascript:void(0);" class="ds-current">'+a+"</a>"),a<e.pages){for(s=a+1;s<=a+4&&s<e.pages;s++)t(s);s<e.pages&&i.push('<span class="page-break">...</span>'),t(e.pages)}this.el.html('<div class="ds-border"></div>'+i.join(" "))[1<e.pages?"show":"hide"]()}},oe.smiliesTooltip=function(e){var t='<div id="ds-smilies-tooltip"><ul class="ds-smilies-tabs">';for(var s in e)t+="<li><a>"+s+"</a></li>";return t+'</ul><div class="ds-smilies-container"></div></div>'},X.addSmilies=function(e,t){var s=X.smiliesTooltip;s&&s.el.find("ul.ds-smilies-tabs").append("<li><a>"+e+"</a></li>"),X.smilies[e]=t},se.SmiliesTooltip=function(){},se.SmiliesTooltip.prototype={render:function(){var r=this,e=r.el=y(oe.smiliesTooltip(ne));return e.click(l).find("ul.ds-smilies-tabs").delegate("a","click",function(e){r.reset(this.innerHTML)}),e.find(".ds-smilies-container").delegate("img","click",function(e){var t=r.replybox,s=t.el.find("textarea")[0],a=s.value;if(q.selection){s.value=a.substring(0,$.start)+this.title+a.substring($.end,a.length),s.value=s.value.replace(ee.leave_a_message,""),s.focus();var i=q.selection.createRange();i.moveStart("character",$.start+this.title.length),i.collapse(),i.select()}else{var n=s.selectionStart+this.title.length;s.value=a.substring(0,s.selectionStart)+this.title+a.substring(s.selectionEnd),s.setSelectionRange(n,n)}t.hideSmilies(),s.focus()}),this},reset:function(a){var e=this.el.find("ul.ds-smilies-tabs");e.find("a.ds-current").removeClass("ds-current"),e.find("a").filter(function(){return this.innerHTML==a}).addClass("ds-current");var i="<ul>";return y.each(ne[a],function(e,t){var s=0===a.indexOf("微博")?"http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/"+t.replace("_org","_thumb"):J+"/images/smilies/"+t;"WordPress"===a&&(e=" "+e+" "),i+='<li><img src="'+s+'" title="'+F(e)+'" /></li>'}),i+="</ul>",this.el.find(".ds-smilies-container").html(i),this}},oe.postPlaceholder=function(){return'<li class="ds-post ds-post-placeholder">'+ee.no_comments_yet+"</li>"},oe.post=function(e,t){var s=de(e),a=s.user_id?' data-user-id="'+s.user_id+'"':"",i=s.qqt_account||"",n=oe.timeHtml(e.created_at,e.url),r=e.parents||[];switch(e.source){case"duoshuo":n+='<a class="ds-post-reply" href="javascript:void(0);"><span class="ds-icon ds-icon-reply"></span>'+ee.reply+"</a>"+oe.likePost(e)+'<a class="ds-post-repost" href="javascript:void(0);"><span class="ds-icon ds-icon-share"></span>'+ee.repost+'</a><a class="ds-post-report" href="javascript:void(0);"><span class="ds-icon ds-icon-report"></span>'+ee.report+"</a>"+(e.privileges.delete?'<a class="ds-post-delete" href="javascript:void(0);"><span class="ds-icon ds-icon-delete"></span>'+ee.delete+"</a>":"");break;case"qqt":case"weibo":n+='<a class="ds-weibo-comments" href="javascript:void(0);">'+ee.comments+(e.type.match(/\-comment$/)?"":'(<span class="ds-count">'+e.comments+"</span>)")+'</a><a class="ds-weibo-reposts" href="javascript:void(0);">'+ee.reposts+(e.type.match(/\-comment$/)?"":'(<span class="ds-count">'+e.reposts+"</span>)")+"</a>"}return'<li class="ds-post" data-post-id="'+e.post_id+'"><div class="ds-post-self" data-post-id="'+e.post_id+'" data-thread-id="'+e.thread_id+'" data-root-id="'+e.root_id+'" data-source="'+e.source+'"><div class="ds-avatar"'+a+">"+oe.avatar(s)+(X.sourceName[e.source]?oe.serviceIcon(e.source):"")+'</div><div class="ds-comment-body"><div class="ds-comment-header">'+(s.url?'<a class="ds-user-name ds-highlight" data-qqt-account="'+i+'" href="'+F(s.url)+'" '+(s.user_id?" onclick=\"this.href='"+X.hostUrl+"/user-url/?user_id="+s.user_id+"';\"":"")+' rel="nofollow" target="_blank"'+a+">"+F(s.name)+"</a>":'<span class="ds-user-name"'+a+' data-qqt-account="'+i+'">'+F(s.name)+"</span>")+'<span class="ua">'+sskadmin(e.author)+'</span><span class="ua">'+ua(e.agent)+'</span><span class="ua">'+os(e.agent)+"</span></div>"+(1==t.max_depth&&t.show_context&&r.length?'<ol id="ds-ctx">'+y.map(r,function(e,t){return(1==t&&2<r.length?'<li class="ds-ctx-entry"><a href="javascript:void(0);" class="ds-expand">还有'+(r.length-2)+"条评论</a></li>":"")+(fe[e]?oe.ctxPost(fe[e].data,t,t&&t<r.length-1):"")}).join("")+"</ol>":"")+"<p>"+(r.length>=t.max_depth&&(!t.show_context||1<t.max_depth)&&e.parent_id&&fe[e.parent_id]?'<a class="ds-comment-context" data-post-id="'+e.post_id+'" data-parent-id="'+e.parent_id+'">'+ee.reply_to+F(de(fe[e.parent_id].data).name)+": </a>":"")+e.message+'</p><div class="ds-comment-footer ds-comment-actions'+(0<e.vote?" ds-post-liked":"")+'">'+n+"</div></div></div>"+(1<t.max_depth&&(e.childrenArray||e.children)&&"weibo"!=e.source&&"qqt"!=e.source?'<ul class="ds-children">'+y.map(e.childrenArray||e.children,function(e){return fe[e]?oe.post(fe[e].data,t):""}).join("")+"</ul>":"")+"</li>"};function m(){bubbleOutTimer&&(clearTimeout(bubbleOutTimer),bubbleOutTimer=0)}var f=y('<div id="ds-bubble"><div class="ds-bubble-content"></div><div class="ds-arrow ds-arrow-down ds-arrow-border"></div><div class="ds-arrow ds-arrow-down"></div></div>'),k=f.find(".ds-bubble-content").delegate("a.ds-ctx-open","click",function(e){O("/api/posts/conversation",{post_id:k.attr("data-post-id")},function(e){t.el.find("ol").html(y.map(e.response,oe.ctxPost).join("\n"))});var t=ae('<h2>查看对话</h2><ol id="ds-ctx"></ol>');return t.el.find(".ds-dialog").css("width","600px"),t.el.find(".ds-dialog-body").css({"max-height":"350px",_height:"350px","overflow-y":"auto","padding-top":"10px"}),!1}),x=bubbleOutTimer=0;bubbleOut=function(){bubbleOutTimer=setTimeout(function(){bubbleOutTimer=0,f.detach()},400)},f.mouseenter(m).mouseleave(bubbleOut),oe.userInfo=function(e){var s=[];return y.each(e.social_uid,function(e,t){s.push('<a href="'+X.REMOTE+"/user-proxy/"+e+"/"+t+'/" target="_blank" class="ds-service-icon ds-'+e+'" title="'+X.sourceName[e]+'"></a>')}),'<a href="'+F(e.url)+'" class="ds-avatar" target="_blank">'+oe.avatarImg(e)+'</a><a href="'+F(e.url)+'" class="ds-user-name ds-highlight" target="_blank">'+F(e.name)+"</a>"+s.join("")+'<p class="ds-user-card-meta"><a href="'+X.REMOTE+"/profile/"+e.user_id+'/" target="_blank"><span class="ds-highlight">'+e.comments+"</span>条评论</a></p>"+(e.description?'<p class="ds-user-description">'+F(e.description)+"</p>":"")},te.PostList=function(e){e&&(e.params&&(this.params=e.params),e.embedThread&&(this.embedThread=e.embedThread)),this.el=y('<ul class="ds-comments"></ul>')},te.PostList.prototype={url:"/api/threads/listPosts",render:function(){return t.call(this.el,this.embedThread,this.embedThread.options),this},reset:function(e){var t=this.embedThread.options;this.el.html(e[0]?y.map(e,function(e){return fe[e]?oe.post(fe[e].data,t):""}).join(""):oe.postPlaceholder())},refetch:function(){var t=this,s=y(oe.indicator()).appendTo(q.body).fadeIn(200);t.el.fadeTo(200,.5),O(t.url,t.params,function(e){j(fe,e.parentPosts||e.relatedPosts),j(ve,e.users),t.reset(e.response),t.embedThread.paginator.reset(e.cursor),t.el.fadeTo(200,1),X.scrollTo(t.el),s.remove()})}},X.repostDialog=function(e,t,i,n){var s=ae('<h2>转发到微博</h2><div class="ds-quote"><strong>@'+F(de(e.data).name)+"</strong>: "+e.data.message+"</div><form>"+re({post_id:e.data.post_id})+'<div class="ds-textarea-wrapper"><textarea name="message" title="Ctrl+Enter快捷提交" placeholder="'+F(ee.repost_reason)+'">'+F(t)+'</textarea><pre class="ds-hidden-text"></pre></div><div class="ds-actions">'+(n?re({"service[]":n}):'<label><input type="checkbox" name="service[]" value="weibo"'+(pe.data.social_uid.weibo?' checked="checked"':"")+' /><span class="ds-service-icon ds-weibo"></span>新浪微博</label>  <label><input type="checkbox" name="service[]" value="qqt"'+(pe.data.social_uid.qq?' checked="checked"':"")+' /><span class="ds-service-icon ds-qqt"></span>腾讯微博</label>')+'<button type="submit">'+ee.repost+"</button></div></form>"),a=s.el.find("form").submit(function(e){return n||a.find("[type=checkbox]:checked")[0]?(L("/api/posts/repost",X.toJSON(a),function(e){if(i&&n){var t=i.options,s=v(i.postList.el,e.response[n],t);"asc"==t.order==("top"==t.formPosition)&&X.scrollTo(s);var a=i.el.find(".ds-comments-tab-"+n+" span.ds-highlight");a.html(parseInt(a.html())+1)}}),s.close()):alert("还没有选发布到哪儿呢"),!1});return a.find(".ds-actions [type=checkbox]").change(function(e){var t=this.value;!this.checked||pe.data.social_uid["qqt"==t?"qq":t]||d(t)}),_(a.find("textarea")).keyup(g).keyup(b).focus(),!1},oe.toolbar=function(e){var t=oe.logoutUrl();return'<div class="ds-toolbar"><div class="ds-account-control"><span class="ds-icon ds-icon-settings"></span> <span>帐号管理</span><ul><li><a class="ds-bind-more" href="javascript:void(0);" style="border-top: none">绑定更多</a></li><li><a target="_blank" href="'+X.REMOTE+"/settings/"+N(z())+'">'+F(ee.settings)+'</a></li><li><a rel="nofollow" href="'+t+'" style="border-bottom: none">登出</a></li></ul></div><div class="ds-visitor">'+(pe.data.url?'<a class="ds-visitor-name" href="'+F(pe.data.url)+'" target="_blank">'+F(pe.data.name)+"</a>":'<span class="ds-visitor-name">'+F(pe.data.name)+"</span>")+'<a class="ds-unread-comments-count" href="javascript:void(0);" title="新回复"></a></div></div>'},se.EmbedThread=a.extend({uri:"/api/threads/listPosts",params:"thread-id local-thread-id source-thread-id thread-key category channel-key author-key author-id url limit order max-depth form-position container-url"+(W.match(/MSIE 6\.0/)?"":" title image thumbnail"),render:function(){var e=this.el.attr("id","ds-thread").append(oe.waitingImg()),t=e.width(),s=e.data("url")||!e.attr("data-thread-id")&&y("link[rel=canonical]").attr("href");s?e.data("url",function(e){if(e.match(/^(http|https):/))return e;var t=q.createElement("a");return t.href=e,Y.hrefNormalized?t.href:t.getAttribute("href",4)}(s)):e.data("container-url",Q.href),t&&t<=400&&e.addClass("ds-narrow").data("max-depth",1)},updateCounter:function(e){var t={duoshuo:["comments","评论"],repost:["reposts","转载"],weibo:["weibo_reposts","新浪微博"],qqt:["qqt_reposts","腾讯微博"]};for(var s in t)if(!e||e==s){var a=this.data[t[s][0]];this.el.find(".ds-comments-tab-"+s).html(this.el.hasClass("ds-narrow")?'<span class="ds-service-icon ds-'+s+'"></span>'+a:(a?'<span class="ds-highlight">'+a+"</span>条":"")+t[s][1])}},onError:function(e){this.el.html("评论框出错啦("+e.code+"): "+e.errorMessage)},onload:function(e){var s=this,t=s.threadId=e.thread.thread_id,a=e.cursor,i=s.options=e.options,n=s.innerEl=u(y('<div id="ds-reset"></div>').appendTo(s.el));s.data=e.thread,j(fe,e.parentPosts||e.relatedPosts),j(ve,e.users),s.el.find("#ds-waiting").remove(),i.like_thread_enabled&&(s.meta=new se.Meta(s),s.meta.render().el.appendTo(n)),i.hot_posts&&e.hotPosts&&e.hotPosts.length&&(s.hotPosts=new se.HotPosts(y('<div class="ds-rounded"></div>'),{max_depth:1,show_context:i.show_context}),(s.hotPosts.thread=s).hotPosts.el.appendTo(n),s.hotPosts.onload({response:e.hotPosts,options:{}})),s.postListHead=new se.PostListHead(s),s.postList=new te.PostList({embedThread:s,params:{source:"duoshuo",thread_id:t,max_depth:i.max_depth,order:i.order,limit:i.limit}}),s.postList.render().reset(e.response),s.paginator=new se.Paginator({collection:s.postList}),s.paginator.reset(a);var r=s.replybox=new se.Replybox(s),o=r.render().el.find("textarea");if(r.postList=s.postList.el,B){var d="ds_draft_"+t;o.bind("focus blur keyup",function(e){var t=y(e.currentTarget).val();try{B[d]=t}catch(e){}}),B[d]&&o.val(B[d])}if(E()){var l=y(oe.loginButtons()).delegate("a.ds-more-services","click",function(){return l.find(".ds-additional-services").toggle(),!1});w(l)}else s.toolbar=y(oe.toolbar()).delegate(".ds-account-control","mouseenter",function(){y(this).addClass("ds-active")}).delegate(".ds-account-control","mouseleave",function(){y(this).removeClass("ds-active")}).delegate("a.ds-bind-more","click",function(){var e=ae("<h2>绑定更多帐号</h2>"+oe.serviceList(1)+oe.additionalServices(1)+'<div style="clear:both"></div>').el.find(".ds-dialog").addClass("ds-dialog-bind-more").css("width","300px");return w(e),!1}).delegate("a.ds-unread-comments-count","click",function(e){return h("unread-comments"),!1});s.postListHead.render().el.appendTo(n)["top"==i.formPosition?"before":"after"]('<a name="respond"></a>',s.toolbar||l,r.el).after(s.postList.el,s.paginator.el),s.updateCounter(),e.alerts&&y.each(e.alerts,function(e,t){y('<div class="ds-alert">'+t+"</div>").insertBefore(s.toolbar||l)}),i.message&&o.val(i.message).focus(),y(oe.poweredBy(i.poweredby_text)).appendTo(n),he.on("reset",function(){var e=he.data.comments||0;n.find("a.ds-unread-comments-count").html(e).attr("title",e?"你有"+e+"条新回复":"你没有新回复").css("display",e?"inline":"none")}),i.mzadx_id&&(X.require("mzadxN",function(){}),y('<div id="MZADX_'+i.mzadx_id+'" style="margin:0 auto;"></div>').appendTo(n),__mz_rpq=T.__mz_rpq||[],__mz_rpq.push({l:[i.mzadx_id],r:"1",_srv:"MZADX",_callback:function(e,t){}})),X.thread=s,he.data!==C&&he.trigger("reset"),E()||I({visit_thread_id:s.threadId})},onMessage:function(e){v(this.postList.el,e,this.options)}}),oe.hotPosts=function(e,t){return'<div class="ds-header ds-gradient-bg">'+ee.hot_posts_title+"</div><ul>"+y.map(e,function(e){return fe[e]?oe.post(fe[e].data,t):""}).join("")+"</ul>"},se.HotPosts=a.extend({params:"show-quote",tmpl:"hotPosts",render:function(){return this.el.attr("id","ds-hot-posts"),this},onload:function(e){a.prototype.onload.call(this,e),t.call(this.el.find("ul"),this.thread,this.options)}}),oe.commentList=function(e,s){return y.map(e,function(e){var t=de(e);return'<li class="ds-comment'+(s.show_avatars?" ds-show-avatars":"")+'" data-post-id="'+e.post_id+'">'+(s.show_avatars?'<div class="ds-avatar">'+oe.avatar(t,s.avatar_size)+"</div>":"")+'<div class="ds-meta">'+oe.userAnchor(t)+(s.show_time?oe.timeHtml(e.created_at):"")+"</div>"+(s.show_title?'<div class="ds-thread-title">在 <a href="'+F(e.thread.url+"#comments")+'">'+F(e.thread.title)+'</a> 中评论</div><div class="ds-excerpt">'+e.message+"</div>":'<a class="ds-excerpt" title="'+F(e.thread.title)+' 中的评论" href="'+F(e.thread.url+"#comments")+'">'+e.message+"</a>")+"</li>"}).join("")},se.RecentComments=a.extend({uri:"/api/sites/listRecentPosts",params:"show-avatars show-time show-title avatar-size show-admin excerpt-length num-items channel-key",tmpl:"commentList",render:function(){this.el.attr("id","ds-recent-comments")}}),oe.recentVisitors=function(e,t){return y.map(e,function(e){return'<div class="ds-avatar">'+oe.avatar(e,t.avatar_size)+"</div>"}).join("")},se.RecentVisitors=a.extend({uri:"/api/sites/listVisitors",params:"show-time avatar-size num-items channel-key",tmpl:"recentVisitors",render:function(){this.el.children().detach(),this.el.attr("id","ds-recent-visitors").append(this.waitingEl=y(oe.waitingImg()))}}),oe.topUsers=function(e,t){return y.map(e,function(e){return'<div class="ds-avatar">'+oe.avatar(e,t.avatar_size)+"<h4>"+e.name+"</h4></div>"}).join("")},se.TopUsers=a.extend({uri:"/api/sites/listTopUsers",params:"show-time avatar-size num-items channel-key",tmpl:"topUsers",render:function(){this.el.children().detach(),this.el.attr("id","ds-top-users").append(this.waitingEl=y(oe.waitingImg()))}}),oe.topThreads=function(e,t){return y.map(e,function(e){return'<li><a target="_blank" href="'+F(e.url)+'" title="'+e.title+'">'+e.title+"</a></li>"}).join("")},se.TopThreads=a.extend({uri:"/api/sites/listTopThreads",params:"range num-items channel-key",tmpl:"topThreads",render:function(){this.el.children().detach(),this.el.attr("id","ds-top-threads").append(this.waitingEl=y(oe.waitingImg()))}}),oe.loginWidget=function(){var s='<div class="ds-icons-32">';return y.each(["weibo","qq","renren","kaixin","douban","netease","sohu"],function(e,t){s+='<a class="ds-'+t+'" href="'+oe.loginUrl(t)+'">'+X.sourceName[t]+"</a>"}),s+"</div>"},se.LoginWidget=a.extend({tmpl:"loginWidget",render:function(){var e=this.el;e.attr("id","ds-login").html(oe.loginWidget()),w(e,"a"),e.find("a.ds-logout").attr("href",oe.logoutUrl())}}),se.ThreadCount=a.extend({onload:function(e){var t=this.el,s=t.data("count-type")||"comments",a=e.data[s];t[t.data("replace")?"replaceWith":"html"](ee[s+"_"+(a?1<a?"multiple":"one":"zero")].replace("{num}",a))}});var r=0;X.initSelector=function(e,r){var o=[];!R()||!y.isReady&&G||y(e).each(function(e,t){var s=y(t);if(!s.data("initialized")){s.data("initialized",!0);var a=new se[r.type](s,r);if(K.push(a),"ThreadCount"===r.type){var i=s.attr("data-thread-key");s.attr("data-channel-key")&&(i=s.attr("data-channel-key")+":"+i),o.push(i),me[i]||(me[i]=new ce({})),me[i].on("reset",function(){a.onload(this)})}else if(a.uri){var n={};y.each(a.params.split(" "),function(e,t){n[t.replace(/-/g,"_")]=s.attr("data-"+t)||s.data(t)}),O(a.uri,c(n),function(e){a.load(e)})}}}),o.length&&O("/api/threads/counts",c({threads:o.join(",")}),function(e){p(e),S(ee,e.options),j(me,e.response)})},(X.initView=function(){y.each(Z,X.initSelector)})(),y(function(){if(!R())return ie("缺少duoshuoQuery的定义");setInterval(function(){y(".ds-time").each(function(){var e=y(this).attr("datetime");e&&(this.innerHTML=X.elapsedTime(e))})},2e4),H.ondomready&&H.ondomready(),X.initView(),!r&&H.short_name&&O("/api/analytics/ping",c({}),p)})})}function k(e){return i[e]||"&amp;"}}(window,document);